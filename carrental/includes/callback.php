<?php
session_start();

require_once 'config.php';

if (isset($_GET["code"])) {
    // Attempt to exchange a code for a valid authentication token.
    $token = $google_client->fetchAccessTokenWithAuthCode($_GET["code"]);

    // Check if there is an error during token retrieval.
    if (!isset($token['error'])) {
        $_SESSION['logged'] = true;

        // Set the access token used for requests.
        $google_client->setAccessToken($token['access_token']);

        // Store "access_token" value in $_SESSION variable for future use.
        $_SESSION['access_token'] = $token['access_token'];

        // Create an object of the Google_Service_Oauth2 class.
        $google_service = new Google_Service_Oauth2($google_client);

        // Get user profile data from Google.
        $data = $google_service->userinfo->get();
        $name = $data->given_name;
        $email = $data->email;
        $google_id = $data->id;

        $sql = "INSERT INTO `tblauthi`(`google_id`, `FullName`, `EmailId`) VALUES (:google_id, :full_name, :email)";

        try {
            $query = $dbh->prepare($sql);
            $query->bindValue(':google_id', $google_id, PDO::PARAM_STR);
            $query->bindValue(':full_name', $data->given_name . ' ' . $data->family_name, PDO::PARAM_STR);
            $query->bindValue(':email', $email, PDO::PARAM_STR);

            if ($query->execute()) {
                $sql = "SELECT EmailId, google_id, FullName FROM tblauthi WHERE EmailId=:email AND google_id=:google_id";

                $query = $dbh->prepare($sql);
                $query->bindValue(':email', $email, PDO::PARAM_STR);
                $query->bindValue(':google_id', $google_id, PDO::PARAM_STR);
                $query->execute();

                $results = $query->fetchAll(PDO::FETCH_OBJ);

                if ($query->rowCount() > 0) {
                    $name = $results[0]->FullName;
                    $_SESSION['login'] = $email;
                    $_SESSION['fname'] = $name;
                    echo "<script type='text/javascript'> document.location = '/carrental/'; </script>";
                } else {
                    echo "<script>alert('Invalid Details');</script>";
                }
            } else {
                echo "<script>alert('Error inserting data');</script>";
            }
        } catch (PDOException $e) {
            echo "<script>alert('Database error: " . $e->getMessage() . "');</script>";
        }
    }
}
?>